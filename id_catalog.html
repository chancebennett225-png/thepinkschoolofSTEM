<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital ID Card Catalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        window.initFirebase = async () => {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                window.storage = getStorage(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("User authenticated:", window.userId);
                        document.getElementById('user-id').textContent = `User ID: ${window.userId}`;
                        loadCards();
                    } else {
                        console.log("No user signed in. Signing in anonymously.");
                        await signInAnonymously(auth);
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Firebase initialization error:", e);
                const errorDiv = document.createElement('div');
                errorDiv.className = "bg-red-500 text-white p-4 rounded-lg mt-4";
                errorDiv.textContent = "Error initializing Firebase. Please contact support.";
                document.body.prepend(errorDiv);
            }
        };

        window.loadCards = () => {
            if (!window.db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const cardsCollection = collection(db, `/artifacts/${appId}/public/data/idCards`);
            onSnapshot(cardsCollection, (snapshot) => {
                const cardCatalog = document.getElementById('card-catalog');
                cardCatalog.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const cardElement = document.createElement('div');
                    cardElement.className = "bg-pink-50 p-4 rounded-lg shadow-md text-center";
                    cardElement.innerHTML = `
                        <img src="${data.imageUrl}" alt="${data.name}'s ID Card" class="w-full h-auto rounded-md mb-2 object-cover aspect-[4/3]">
                        <p class="font-bold text-lg">${data.name}</p>
                        <p class="text-sm text-gray-600">${data.role}</p>
                    `;
                    cardCatalog.appendChild(cardElement);
                });
            });
        };

        window.uploadCard = async (event) => {
            event.preventDefault();
            const fileInput = document.getElementById('id-card-file');
            const name = document.getElementById('uploader-name').value;
            const role = document.getElementById('uploader-role').value;
            const file = fileInput.files[0];

            if (!file || !name || !role) {
                document.getElementById('upload-status').textContent = "Please fill out all fields and select a file.";
                return;
            }

            const statusDiv = document.getElementById('upload-status');
            statusDiv.textContent = "Uploading... please wait.";

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const fileRef = ref(storage, `/artifacts/${appId}/idCards/${file.name}`);
                await uploadBytes(fileRef, file);
                const imageUrl = await getDownloadURL(fileRef);

                const cardsCollection = collection(db, `/artifacts/${appId}/public/data/idCards`);
                await addDoc(cardsCollection, {
                    name: name,
                    role: role,
                    imageUrl: imageUrl,
                    userId: window.userId || 'anonymous'
                });

                statusDiv.textContent = "Upload successful! Your card is now in the catalog.";
                document.getElementById('upload-form').reset();
            } catch (error) {
                console.error("Upload error:", error);
                statusDiv.textContent = "Upload failed. Please try again.";
            }
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce7f3;
        }
        .aspect-4-3 {
            aspect-ratio: 4 / 3;
        }
    </style>
</head>
<body class="text-[#831843]" onload="initFirebase()">

    <div class="min-h-screen">
        <header class="bg-[#d53f8c] text-white p-8 text-center shadow-lg">
            <h1 class="text-4xl font-black">Digital ID Card Catalog</h1>
            <p class="mt-2 max-w-3xl mx-auto">Create and share your official Pink School of STEM ID Card with the community.</p>
        </header>

        <main class="container mx-auto p-4 md:p-8">
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-4 text-[#db2777]">1. Your Guide to Creating a Digital ID Card</h2>
                <p class="mb-4">Your ID card is a reflection of your personality and your role at the Pink School of STEM. We encourage you to be creative and make a design that's uniquely you!</p>

                <h3 class="text-xl font-bold mb-2">What to Include:</h3>
                <ul class="list-disc list-inside mb-4 ml-4 space-y-2">
                    <li>**Your Name:** Your full name should be clearly visible.</li>
                    <li>**Your Role:** Choose from "Student/Parent" or "Staff."</li>
                    <li>**A Photo or Avatar:** A clear headshot or a creative avatar that represents you.</li>
                    <li>**Personal Flair:** Add a design, an emoji, a favorite quote, or anything else that reflects your personality!</li>
                </ul>

                <h3 class="text-xl font-bold mb-2">Free Online Design Tools:</h3>
                <p class="mb-4">We recommend using these free, easy-to-use programs. When designing, aim for a card with an aspect ratio of **4:3 (width:height)** for the best display in our catalog.</p>
                <ul class="list-disc list-inside mb-4 ml-4 space-y-2">
                    <li>**Canva:** An excellent drag-and-drop tool with many free templates. </li>
                    <li>**Figma:** A powerful, collaborative design tool that's perfect for creating simple graphics. </li>
                    <li>**Adobe Express:** A user-friendly tool from Adobe for quick and stylish designs. </li>
                </ul>

                <h3 class="text-xl font-bold mb-4">Example Card:</h3>
                <div class="flex justify-center">
                    <div style="position: relative; width: 100%; height: 0; padding-top: 56.2500%; padding-bottom: 0; box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16); margin-top: 1.6em; margin-bottom: 0.9em; overflow: hidden; border-radius: 8px; will-change: transform;">
                        <iframe loading="lazy" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: none; padding: 0;margin: 0;" src="https://www.canva.com/design/DAGyD1w3fM8/9kpwPV0VE103-2LHLlneBQ/view?embed" allowfullscreen="allowfullscreen" allow="fullscreen"></iframe>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-4 text-[#db2777]">2. Upload Your ID Card</h2>
                <form id="upload-form" onsubmit="uploadCard(event)" class="space-y-4">
                    <div>
                        <label for="uploader-name" class="block text-sm font-bold text-gray-700">Full Name</label>
                        <input type="text" id="uploader-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#d53f8c] focus:ring focus:ring-[#d53f8c] focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="uploader-role" class="block text-sm font-bold text-gray-700">Role</label>
                        <select id="uploader-role" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#d53f8c] focus:ring focus:ring-[#d53f8c] focus:ring-opacity-50">
                            <option value="" disabled selected>Select a role</option>
                            <option value="Student/Parent">Student/Parent</option>
                        </select>
                    </div>
                    <div>
                        <label for="id-card-file" class="block text-sm font-bold text-gray-700">Upload Image</label>
                        <input type="file" id="id-card-file" accept="image/*" required class="mt-1 block w-full">
                    </div>
                    <div class="flex items-center justify-between mt-6">
                         <button type="submit" class="bg-[#d53f8c] hover:bg-[#c0397a] text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 w-full">
                            Upload Card
                         </button>
                    </div>
                    <p id="upload-status" class="text-center text-sm font-medium mt-2"></p>
                </form>
            </div>

            <div class="mt-12">
                <h2 class="text-2xl font-bold mb-4 text-[#db2777] text-center">3. Digital Catalog</h2>
                <p id="user-id" class="text-center font-bold text-sm mb-4"></p>
                <div id="card-catalog" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <p class="col-span-full text-center text-gray-500">Loading digital cards...</p>
                </div>
            </div>
        </main>
        <div class="text-center mt-12 mb-8">
            <a href="index.html" class="bg-[#d53f8c] hover:bg-[#c0397a] text-white font-bold py-3 px-8 rounded-lg shadow-xl transition-transform transform hover:scale-105 inline-block">View Infographic</a>
        </div>
    </div>
</body>
</html>
